templates:
  builder:
    name: "NSS"
    description: "Build NSS & NSPR"
    artifact: "dist.tar.bz2"
    command:
      - "/bin/bash"
      - "-c"
      - "bin/checkout.sh && nss/automation/taskcluster/scripts/build.sh"
    env:
      NSS_ENABLE_TLS_1_3: 1
    treeherder:
      symbol: B
    subtasks:
      - cert
      - chains
      - cipher
      - crmf
      - dbtests
      - ec
      - fips
      - gtests
      - libpkix
      - lowhash
      - merge
      - ocsp
      - pkits
      - sdr
      - smime
      - ssl
      - tools

  test_runner:
    command:
      - "/bin/bash"
      - "-c"
      - "bin/checkout.sh && nss/automation/taskcluster/scripts/run_tests.sh"

  cert:
    name: "cert tests"
    description: "Cert tests"
    extends: test_runner
    env:
      NSS_TESTS: "cert"
    treeherder:
      symbol: Cert

  chains:
    name: "chains tests"
    description: "Chains tests"
    extends: test_runner
    env:
      NSS_TESTS: "chains"
    treeherder:
      symbol: Chains

  cipher:
    name: "cipher tests"
    description: "Cipher tests"
    extends: test_runner
    env:
      NSS_TESTS: "cipher"
    treeherder:
      symbol: Cipher

  crmf:
    name: "crmf tests"
    description: "CRMF tests"
    extends: test_runner
    env:
      NSS_TESTS: "crmf"
    treeherder:
      symbol: CRMF

  dbtests:
    name: "dbtests"
    description: "DBTests"
    extends: test_runner
    env:
      NSS_TESTS: "dbtests"
    treeherder:
      symbol: DBTests

  ec:
    name: "EC tests"
    description: "EC tests"
    extends: test_runner
    env:
      NSS_TESTS: "ec"
    treeherder:
      symbol: EC

  fips:
    name: "FIPS tests"
    description: "FIPS tests"
    extends: test_runner
    env:
      NSS_TESTS: "fips"
    treeherder:
      symbol: FIPS

  gtests:
    name: "GTests"
    description: "GTests"
    extends: test_runner
    env:
      NSS_TESTS: "ssl_gtests gtests"
    treeherder:
      symbol: GTest

  libpkix:
    name: "libpkix tests"
    description: "libpkix tests"
    extends: test_runner
    env:
      NSS_TESTS: "libpkix"
    treeherder:
      symbol: PKIX

  lowhash:
    name: "lowhash tests"
    description: "lowhash tests"
    extends: test_runner
    env:
      NSS_TESTS: "lowhash"
    treeherder:
      symbol: Lowhash

  merge:
    name: "merge tests"
    description: "Merge tests"
    extends: test_runner
    env:
      NSS_TESTS: "merge"
    treeherder:
      symbol: Merge

  ocsp:
    name: "ocsp tests"
    description: "OCSP tests"
    extends: test_runner
    env:
      NSS_TESTS: "ocsp"
    treeherder:
      symbol: OCSP

  pkits:
    name: "pkits tests"
    description: "NIST PKITS tests"
    extends: test_runner
    env:
      NSS_TESTS: "pkits"
    treeherder:
      symbol: PKITS

  sdr:
    name: "sdr tests"
    description: "SDR tests"
    extends: test_runner
    env:
      NSS_TESTS: "sdr"
    treeherder:
      symbol: SDR

  smime:
    name: "smime tests"
    description: "S/MIME tests"
    extends: test_runner
    env:
      NSS_TESTS: "smime"
    treeherder:
      symbol: SMIME

  ssl: # Update this when TLS v1.3 doesn't fail these anymore.
    name: "ssl tests"
    description: "SSL tests"
    artifact: "dist.tar.bz2"
    command:
      - "/bin/bash"
      - "-c"
      - "bin/checkout.sh && nss/automation/taskcluster/scripts/build.sh"
    env:
      NSS_ENABLE_TLS_1_3: "" # Remove this.
      NSS_TESTS: "ssl"
    treeherder:
      groupSymbol: SSL
      groupName: SSL tests
    subtasks:
      - ssl1
      - ssl2
      - ssl3
      - ssl4

  ssl1:
    name: "cycle=standard"
    extends: test_runner
    env:
      NSS_CYCLES: "standard"
    treeherder:
      symbol: "std"
  ssl2:
    name: "cycle=pkix"
    extends: test_runner
    env:
      NSS_CYCLES: "pkix"
    treeherder:
      symbol: "pkix"
  ssl3:
    name: "cycle=upgradedb"
    extends: test_runner
    env:
      NSS_CYCLES: "upgradedb"
    treeherder:
      symbol: "udb"
  ssl4:
    name: "cycle=sharedb"
    extends: test_runner
    env:
      NSS_CYCLES: "sharedb"
    treeherder:
      symbol: "sdb"

  tools:
    name: "tools tests"
    description: "Tools tests"
    extends: test_runner
    env:
      NSS_TESTS: "tools"
    treeherder:
      symbol: Tools

graph:
  build-32-debug:
    name: "Linux 32 (debug)"
    extends: builder
    treeherder:
      build:
        platform: linux32
      collection:
        debug: true

  build-32-opt:
    name: "Linux 32 (opt)"
    extends: builder
    env:
      BUILD_OPT: 1
    treeherder:
      build:
        platform: linux32
      collection:
        opt: true

  build-64-debug:
    name: "Linux 64 (debug)"
    extends: builder
    env:
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        debug: true

  build-64-asan:
    name: "Linux 64 (ASan)"
    extends: builder
    env:
      USE_ASAN: 1
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        asan: true

  build-64-opt:
    name: "Linux 64 (opt)"
    extends: builder
    env:
      BUILD_OPT: 1
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        opt: true

# build-32-debug-asan-gcc6:
#   name: "Linux 32 (gcc6, debug, ASan)"
#   extends: builder
#   env:
#     USE_ASAN: 1
#     CCC: g++-6
#     CC: gcc-6

# build-32-opt-gcc6:
#   name: "Linux 32 (gcc6, opt)"
#   extends: builder
#   env:
#     BUILD_OPT: 1
#     CCC: g++-6
#     CC: gcc-6

# build-64-debug-asan-gcc6:
#   name: "Linux 64 (gcc6, debug, ASan)"
#   extends: builder
#   env:
#     USE_ASAN: 1
#     USE_64: 1
#     CCC: g++-6
#     CC: gcc-6

# build-64-opt-gcc6:
#   name: "Linux 64 (gcc6, opt)"
#   extends: builder
#   env:
#     BUILD_OPT: 1
#     USE_64: 1
#     CCC: g++-6
#     CC: gcc-6

  clang-format:
    name: "clang-format-3.8"
    description: "Validate source code formatting"
    command:
      - "/bin/bash"
      - "-c"
      - "bin/checkout.sh && nss/automation/taskcluster/scripts/run_clang_format.sh nss/lib/ssl"
    treeherder:
      symbol: clang-format
      build:
        platform: tools
